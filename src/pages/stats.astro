---
import PageLayout from "../layouts/page-layout.astro";
import Heading from "../components/heading.astro";
import Chart from "../components/chart.astro";
import Carousell from "../components/carousell.astro";
---

<PageLayout>
  <Heading class="text-center fade">Stats</Heading>
  <Carousell>
    <Chart label="Last week" listenTo="chart:week" />
    <Chart label="Last month" listenTo="chart:month" />
    <Chart label="Last year" listenTo="chart:year" />
  </Carousell>
</PageLayout>

<style>
  .fade {
    opacity: 0;
  }
</style>

<script>
  import { format, subMonths, subWeeks, subYears } from "date-fns";
  import { db, type ChartEventDetail, type Rating } from "../utils/db";
  import { fade } from "../utils/animation";

  document.addEventListener("DOMContentLoaded", async () => {
    fade(".fade", {
      startOffset: -50,
    });

    function dispatch(
      type: string,
      thisPeriod: Rating[],
      previousPeriod: Rating[]
    ) {
      window.dispatchEvent(
        new CustomEvent<ChartEventDetail>(type, {
          detail: {
            thisPeriod,
            previousPeriod,
          },
        })
      );
    }

    function formatDate(date: Date): string {
      return format(date, "yyyy-MM-dd");
    }

    const today = new Date();
    const todayFormatted = formatDate(today);
    const oneWeekAgo = formatDate(subWeeks(today, 1));
    const twoWeekAgo = formatDate(subWeeks(today, 2));
    const oneMonthAgo = formatDate(subMonths(today, 1));
    const twoMonthAgo = formatDate(subMonths(today, 2));
    const oneYearAgo = formatDate(subYears(today, 1));
    const twoYearAgo = formatDate(subYears(today, 2));

    const lastWeek = await db.ratings
      .where("date")
      .between(oneWeekAgo, todayFormatted, true, true)
      .toArray();

    const secondLastWeek = await db.ratings
      .where("date")
      .between(twoWeekAgo, oneWeekAgo, true, true)
      .toArray();

    const lastMonth = await db.ratings
      .where("date")
      .between(oneMonthAgo, todayFormatted, true, true)
      .toArray();

    const secondLastMonth = await db.ratings
      .where("date")
      .between(twoMonthAgo, oneMonthAgo, true, true)
      .toArray();

    const lastYear = await db.ratings
      .where("date")
      .between(oneYearAgo, todayFormatted, true, true)
      .toArray();

    const secondLastYear = await db.ratings
      .where("date")
      .between(twoYearAgo, oneYearAgo, true, true)
      .toArray();

    dispatch("chart:week", lastWeek, secondLastWeek);
    dispatch("chart:month", lastMonth, secondLastMonth);
    dispatch("chart:year", lastYear, secondLastYear);
  });
</script>
