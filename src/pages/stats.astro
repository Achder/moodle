---
import PageLayout from "../layouts/page-layout.astro";
import Heading from "../components/heading.astro";
import Chart from "../components/chart.astro";
import Carousell from "../components/carousell.astro";
---

<PageLayout>
  <Heading class="text-center fade">Stats</Heading>
  <Carousell>
    <Chart label="Last week" listenTo="chart:week" />
    <Chart label="Last month" listenTo="chart:month" />
    <Chart label="Last year" listenTo="chart:year" />
  </Carousell>
</PageLayout>

<style>
  .fade {
    opacity: 0;
  }
</style>

<script>
  import { format, subMonths, subWeeks, subYears } from "date-fns";
  import { db, type ChartEventDetail, type Rating } from "../utils/db";
  import { fade } from "../utils/animation";

  document.addEventListener("DOMContentLoaded", async () => {
    fade(".fade", {
      startOffset: -50,
    });

    function dispatch(type: string, ratings: Rating[]) {
      window.dispatchEvent(
        new CustomEvent<ChartEventDetail>(type, {
          detail: {
            ratings,
          },
        })
      );
    }

    const today = new Date();
    const oneWeekAgo = subWeeks(today, 1);
    const oneMonthAgo = subMonths(today, 1);
    const oneYearAgo = subYears(today, 1);

    const todayFormatted = format(today, "yyyy-MM-dd");
    const oneWeekAgoFormatted = format(oneWeekAgo, "yyyy-MM-dd");
    const oneMonthAgoFormatted = format(oneMonthAgo, "yyyy-MM-dd");
    const oneYearAgoFormatted = format(oneYearAgo, "yyyy-MM-dd");

    const lastWeek = await db.ratings
      .where("date")
      .between(oneWeekAgoFormatted, todayFormatted, true, true)
      .toArray();

    const lastMonth = await db.ratings
      .where("date")
      .between(oneMonthAgoFormatted, todayFormatted, true, true)
      .toArray();

    const lastYear = await db.ratings
      .where("date")
      .between(oneYearAgoFormatted, todayFormatted, true, true)
      .toArray();

    dispatch("chart:week", lastWeek);
    dispatch("chart:month", lastMonth);
    dispatch("chart:year", lastYear);
  });
</script>
